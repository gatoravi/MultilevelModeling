---
title: "HW8"
author: "Avinash Ramu"
date: "November 9, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Q18.2
I will use the radon model that Andrew used in his demo.
```{r q2_1}
library(lme4)
library(arm)
library(rjags); library(R2jags)

# Setting up the data (from Gelman & Hill's website)
srrs2 <- read.table ("srrs2.dat", header=T, sep=",")
mn <- srrs2$state=="MN"
radon <- srrs2$activity[mn]
log.radon <- log (ifelse (radon==0, .1, radon))
floor <- srrs2$floor[mn]       # 0 for basement, 1 for first floor
n <- length(radon)
y <- log.radon
x <- floor

# get county index variable
county.name <- as.vector(srrs2$county[mn])
uniq <- unique(county.name)
J <- length(uniq)
county <- rep (NA, J)
for (i in 1:J){
  county[county.name==uniq[i]] <- i
}

srrs2.fips <- srrs2$stfips*1000 + srrs2$cntyfips
cty <- read.table ("cty.dat", header=T, sep=",")
usa.fips <- 1000*cty[,"stfips"] + cty[,"ctfips"]
usa.rows <- match (unique(srrs2.fips[mn]), usa.fips)
uranium <- cty[usa.rows,"Uppm"]
u <- log (uranium)

### The actual JAGS code begins here ###

# Saving the model to an object. This allows us to avoid saving the model to a .bug file and sourcing it in
# Make sure it is within quotations!
the.model <- "model{
  for (i in 1:n){
    y[i] ~ dnorm (y.hat[i], tau.y)
    y.hat[i] <- a[county[i]] + b*x[i]
  }
  b ~ dnorm (0, .0001)
  tau.y <- pow(sigma.y, -2)
  sigma.y ~ dunif (0, 100)
  
  for (j in 1:J){
    a[j] ~ dnorm (a.hat[j], tau.a)
    a.hat[j] <- g.0 + g.1*u[j]
  }
  g.0 ~ dnorm (0, .0001)
  g.1 ~ dnorm (0, .0001)
  tau.a <- pow(sigma.a, -2)
  sigma.a ~ dunif (0, 100)
}"

# Defining the data you will pass into the model -- you *already know* these values
radon.data <- list ("n", "J", "x", "y", "county", "u")

# Defining the initial values that your model's parameters (values you *don't* already know)
radon.inits <- function (){list(a=rnorm(J), 
                                b=rnorm(1), 
                                g.0=rnorm(1), 
                                g.1=rnorm(1),
                                sigma.y=runif(1), 
                                sigma.a=runif(1))}

# Defining which parameters of your model you want JAGS to return to you 
# In the book (page 366), they are missing "g.0" and "g.1"
radon.parameters <- c ("a", "b", "sigma.y", "sigma.a", "g.0", "g.1")

# Now, we can actually run the model with the jags() function
radon.3 <- jags(data=radon.data, 
                inits=radon.inits, 
                parameters.to.save=radon.parameters, 
                model.file=textConnection(the.model), # Note the textConnection() function
                n.chains=3, 
                n.iter=5000, 
                DIC=F)

unpooled_model <- lm(y ~ floor + factor(county) - 1)


par(mfrow=c(3, 4))
counties <- sample(1:85, 4)
for(i in counties) {
  curve(dnorm(x, coef(unpooled_model)[i+1], se.coef(unpooled_model)[i+1]), main = uniq[i], ylab="", xlim=c(-5,5))
}

sigma.1 <- runif(1)
for(i in counties){
  curve(dnorm(x, radon.3[[2]]$mean$g.0 + radon.3[[2]]$mean$g.1 * uranium[i], sigma.1), from = -0.5, to = 4.5, main="Prior", xlim=c(-5,5))
}

for(i in counties){
  curve(dnorm(x, radon.3[[2]]$mean$a[i], radon.3[[2]]$sd$a[i]), from=-0.5, to=4.5, main="Posterior", ylab="", xlim=c(-5,5))
}

```

